cmake_minimum_required(VERSION 3.18)

# âœ… Compiler Configuration
set(CMAKE_C_COMPILER "/opt/homebrew/bin/gcc-14")
set(CMAKE_CXX_COMPILER "/opt/homebrew/bin/g++-14")
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# ğŸ”¹ Project Name
project(dataframe)

# ğŸ”¹ Enable C++20 with Modules
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ğŸ”¹ Enable modules explicitly (some compilers need this)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fmodules-ts")

# ğŸ”¹ Find LibTorch (Torch C++ API)
find_package(Torch REQUIRED)

# ğŸ”¹ Locate all source files in src directory (includes .cpp and .ixx files)
file(GLOB_RECURSE SOURCE_FILES src/*.cpp src/*.ixx)

# ğŸ”¹ Add dataframe library
add_library(dataframe STATIC ${SOURCE_FILES})

# ğŸ”¹ Link Torch libraries
target_link_libraries(dataframe PRIVATE "${TORCH_LIBRARIES}")

# ğŸ”¹ Add optimization flags for performance
set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type")
set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3")

# ğŸ”¹ Automatically add executables for test files
file(GLOB_RECURSE TEST_FILES src/*_test.cpp)
foreach(TEST_FILE ${TEST_FILES})
    get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)
    add_executable(${TEST_NAME} ${TEST_FILE})
    target_link_libraries(${TEST_NAME} PRIVATE dataframe)
    message(STATUS "ğŸ” Added test executable: ${TEST_NAME}")
endforeach()

# ğŸ”¹ Display configuration summary
message(STATUS "âœ… Building DataFrame with C++20 Modules")
message(STATUS "ğŸ”¥ Compiler: ${CMAKE_CXX_COMPILER}")
message(STATUS "ğŸ§  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "ğŸ“‚ Source Files Found: ${SOURCE_FILES}")